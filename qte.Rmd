---
title: "Quantile Treatment Effect"
output: html_notebook
---

# Quantile Treatment Effect

We will approach QTE and QTT in two ways.

The first method is to use the estimator proposed by Firpo (2007).[^1] The first step is to estimate the propensity score using a nonparametric method. In his paper, he employed HIR method, which used a logistic power series approximation. The second step is to minimize a weighted sum of check functions.

[^1]: Sergio Firpo. (2007). Efficient Semiparametric Estimation of Quantile Treatment Effects. *Econometrica*, *75*(1), 259–276. <http://www.jstor.org/stable/4123114>

The second method is to use IPW estimators for $F_0(z)$ and $F_1(z)$.[^2] From the estimated distribution of the potential outcomes, we can directly estimate the quantile.

[^2]: Donald, S. G., & Hsu, Y.-C. (2014). Estimation and inference for distribution functions and quantile functions in treatment effect models. *Journal of Econometrics, 178*(3), 383–397. <https://doi.org/10.1016/j.jeconom.2013.03.010>

## 1. Firpo Approach

```{r}
source("scripts/report.R")
source("scripts/qte_f.R")
library(qte)
```

### a. QTE estimation

Check function is defined as

$$
p_r(a) = a \cdot ( \tau - \mathbb{1}(a \leq 0))$$

To find $\hat{q}_{1,r}$ , we minimize

$$ \frac{1}{N} \sum_{i=1}^N \frac{T_i}{\hat{p}(X_i)} \cdot(Y_i - q) \cdot (\tau - 1\{Y_i < q\})$$

We estimate QTE as[^3]

[^3]: **Firpo, S.** (2007). Supplement to "Efficient Semiparametric Estimation of Quantile Treatment Effects." *Econometrica*, 75(1), 259–276, p. 261.

$$
QTE = \hat{q}_{1, \tau} - \hat{q}_{0, \tau}
$$

#### i. Experimental data

For randomized dataset, QTE equals to the differences between quantiles of the treated and the experimental controls[^4].

[^4]: Firpo, S**.** (2007). Supplement to "Efficient Semiparametric Estimation of Quantile Treatment Effects." *Econometrica*, 75(1), 259–276, p. 261. Supplementary Material, p. 3.

```{r}
datasets <- list(re74, psid1_re74, cps1_re74)
taus <- c(0.25, 0.5, 0.75)
```

```{r}
# Run functions on experimental datasets and observational datasets before controlling covariates
ex_qte_list <- lapply(datasets, function(data) {
  estimate_QTEs(data, taus, estimand="QTE", FALSE)
})
```

```{r}
# Display result
col_names <- c("QTE 0.25", "0.5", "0.75")
(ex_qte_result <- create_qte_result(ex_qte_list, c("NSW", "PSID-1", "CPS-1"), col_names))
```

#### **ii. Observational data**

We use the propensity score estimates from Dehejia and Wahba model, and datasets after discarding some controls.

For QTE:

```{r}
# Run functions using IPW method observational datasets to compute QTE
SI_datasets <- list(filtered_psid1_SI, filtered_cps1_SI)
LM_datasets <- list(filtered_psid1, filtered_cps1)
```

```{r}
qte_results.SI <- lapply(SI_datasets, function(data) {
  estimate_QTEs(data, taus)
})

qte_results.logistic <- lapply(LM_datasets, function(data) {
  estimate_QTEs(data, taus)
})
```

```{r}
col_names <- c("QTE IPW 0.25", "0.5", "0.75")
qte.result_table.SI <- create_qte_result(qte_results.SI,  c("NSW", "PSID-1", "CPS-1"), col_names)
qte.result_table.logistic <- create_qte_result(qte_results.logistic,  c("NSW", "PSID-1", "CPS-1"), col_names)
```

```{r}
# Display result
cbind(ex_qte_result, qte.result_table.SI, qte.result_table.logistic)
```

For QTT:

```{r}
qtt_results.logistic <- lapply(LM_datasets, function(data) {
  estimate_QTEs(data, taus, "QTT")
})

qtt_results.SI <- lapply(SI_datasets, function(data) {
  estimate_QTEs(data, taus, "QTT")
})
```

```{r}
col_names <- c("QTT IPW 0.25", "0.5", "0.75")
qtt.result_table.logistic <- create_qte_result(qtt_results.logistic,  c("NSW", "PSID-1", "CPS-1"), col_names)
qtt.result_table.SI <- create_qte_result(qtt_results.SI,  c("NSW", "PSID-1", "CPS-1"), col_names)
(qtt.result_table <- cbind(ex_qte_result, qtt.result_table.SI, qtt.result_table.logistic))
```

### Summary

-   What did I do?

<!-- -->

-   Why are my results so different from Firpo

<!-- -->

-   What makes QTT and QTE so different?

## Playground

```{r}
# Compute qtes
q <- ci.qte(re78~treat, xformla=~age + I(age^2) + education + I(education^2) +
  married + nodegree + black + hispanic + re74 + I(re74^2) +
  re75 + I(re75^2) + u74 * black , se=FALSE, data=filtered_psid1)
summary(q)
```

```{r}
# Compute qtt
qtt <- ci.qtet(re78~treat, xformla=~age + I(age^2) + education + I(education^2) +
  married + nodegree + black + hispanic + re74 + I(re74^2) +
  re75 + I(re75^2) + u74 * black , se=FALSE, data=psid1_re74)

summary(qtt)
```
